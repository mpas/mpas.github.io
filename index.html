<!DOCTYPE html>
<html lang="en-US">
<head>
  
  
  <meta charset="utf-8">
  <title>CodeVerse - CodeVerse</title>
  <meta name="description" content="">
  <meta name="author" content="Marco Pas">

  <meta name="generator" content="" />
  <meta name="robots" content="index,follow">

  
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link href="//fonts.googleapis.com/css?family=Raleway:400,300,600" rel="stylesheet" type="text/css">

  
  
  <link rel="stylesheet" href="/css/normalize.css">
  <link rel="stylesheet" href="/css/skeleton.css">
  
  
  <link rel="stylesheet" href="/css/font-awesome-all.min.css">
 
  
  <script src="/js/prism.js"></script>
  <link rel="stylesheet" href="/css/prism.css">
  
  
  <link rel="stylesheet" href="/css/custom.css">
  
  
  <link rel="icon" type="image/png" href="/images/favicon.png">

</head>

<div class="container">
    <div id="header">
        <div class="row">
            <div class="six columns">
                <div id="brand">
                    <a href="http://mpas.github.io">CodeVerse</a>
                </div>
            </div>
            <div class="six columns">
                <nav class="u-pull-right">
                    <ul id="navbar">
                        
                        
                            <li class="current">
                                <a href="/">Blog</a></li>
                        
                            <li >
                                <a href="/post">Post List</a></li>
                        
                            <li >
                                <a href="/page/about/">About Me</a></li>
                        
                            <li >
                                <a href="/page/resume">Resume</a></li>
                        
                    </ul>
                </nav>
            </div>
        </div>
    </div>
</div>


<div class="container">
    <div class="row">
        <div class="post-list">
        
        
        
            <article class="post u-cf">
    <div class="row">
        <div class="twelve columns">
            <h1 class="post-title">Ranger - Show File in Path Finder</h1>
        </div>
    </div>
    <div class="row">
        <div class="twelve columns">
            <p>Ranger is a VIM-inspired filemanager for the console (<a href="https://ranger.github.io/">https://ranger.github.io/</a>) and can easily be installed by using
<code>brew install ranger</code>. When working in the terminal sometimes it is nice to open the files in the default <code>Finder</code> app
or use the excellent alternative called <code>Path Finder</code>. (<a href="https://cocoatech.com/#/">https://cocoatech.com/#/</a>)</p>
<p>To reveal your files in the Finder or Path Finder create a <code>commands.py</code> in <code>~/.config/ranger</code> and paste the following
code.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="kn">from</span> <span class="nn">ranger.api.commands</span> <span class="kn">import</span> <span class="n">Command</span>

<span class="k">class</span> <span class="nc">show_files_in_path_finder</span><span class="p">(</span><span class="n">Command</span><span class="p">):</span>
    <span class="s2">&#34;&#34;&#34;
</span><span class="s2">    :show_files_in_path_finder
</span><span class="s2">
</span><span class="s2">    Present selected files in finder
</span><span class="s2">    &#34;&#34;&#34;</span>

    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">subprocess</span>
        <span class="n">files</span> <span class="o">=</span> <span class="s2">&#34;,&#34;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;&#34;{0}&#34; as POSIX file&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">file</span><span class="o">.</span><span class="n">path</span><span class="p">)</span> <span class="k">for</span> <span class="nb">file</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fm</span><span class="o">.</span><span class="n">thistab</span><span class="o">.</span><span class="n">get_selection</span><span class="p">()])</span>
        <span class="n">reveal_script</span> <span class="o">=</span> <span class="s2">&#34;tell application </span><span class="se">\&#34;</span><span class="s2">Path Finder</span><span class="se">\&#34;</span><span class="s2"> to reveal {{{0}}}&#34;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">files</span><span class="p">)</span>
        <span class="n">activate_script</span> <span class="o">=</span> <span class="s2">&#34;tell application </span><span class="se">\&#34;</span><span class="s2">Path Finder</span><span class="se">\&#34;</span><span class="s2"> to activate&#34;</span>
        <span class="n">script</span> <span class="o">=</span> <span class="s2">&#34;osascript -e &#39;{0}&#39; -e &#39;{1}&#39;&#34;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">reveal_script</span><span class="p">,</span> <span class="n">activate_script</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fm</span><span class="o">.</span><span class="n">notify</span><span class="p">(</span><span class="n">script</span><span class="p">)</span>
        <span class="n">subprocess</span><span class="o">.</span><span class="n">check_output</span><span class="p">([</span><span class="s2">&#34;osascript&#34;</span><span class="p">,</span> <span class="s2">&#34;-e&#34;</span><span class="p">,</span> <span class="n">reveal_script</span><span class="p">,</span> <span class="s2">&#34;-e&#34;</span><span class="p">,</span> <span class="n">activate_script</span><span class="p">])</span>

<span class="k">class</span> <span class="nc">show_files_in_finder</span><span class="p">(</span><span class="n">Command</span><span class="p">):</span>
    <span class="s2">&#34;&#34;&#34;
</span><span class="s2">    :show_files_in_finder
</span><span class="s2">
</span><span class="s2">    Present selected files in finder
</span><span class="s2">    &#34;&#34;&#34;</span>

    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">subprocess</span>
        <span class="n">files</span> <span class="o">=</span> <span class="s2">&#34;,&#34;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;&#34;{0}&#34; as POSIX file&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">file</span><span class="o">.</span><span class="n">path</span><span class="p">)</span> <span class="k">for</span> <span class="nb">file</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fm</span><span class="o">.</span><span class="n">thistab</span><span class="o">.</span><span class="n">get_selection</span><span class="p">()])</span>
        <span class="n">reveal_script</span> <span class="o">=</span> <span class="s2">&#34;tell application </span><span class="se">\&#34;</span><span class="s2">Finder</span><span class="se">\&#34;</span><span class="s2"> to reveal {{{0}}}&#34;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">files</span><span class="p">)</span>
        <span class="n">activate_script</span> <span class="o">=</span> <span class="s2">&#34;tell application </span><span class="se">\&#34;</span><span class="s2">Finder</span><span class="se">\&#34;</span><span class="s2"> to set frontmost to true&#34;</span>
        <span class="n">script</span> <span class="o">=</span> <span class="s2">&#34;osascript -e &#39;{0}&#39; -e &#39;{1}&#39;&#34;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">reveal_script</span><span class="p">,</span> <span class="n">activate_script</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fm</span><span class="o">.</span><span class="n">notify</span><span class="p">(</span><span class="n">script</span><span class="p">)</span>
        <span class="n">subprocess</span><span class="o">.</span><span class="n">check_output</span><span class="p">([</span><span class="s2">&#34;osascript&#34;</span><span class="p">,</span> <span class="s2">&#34;-e&#34;</span><span class="p">,</span> <span class="n">reveal_script</span><span class="p">,</span> <span class="s2">&#34;-e&#34;</span><span class="p">,</span> <span class="n">activate_script</span><span class="p">])</span>
</code></pre></div><p>Restart Ranger and now you can execute the commands :show_files_in_pathfinder or :show_files_in_finder.</p>

        </div>
    </div>
    <div class="row">
        <div class="twelve columns">
            <div class="post-meta-info">
                Published on
                
                    2018-11-28
                
                <span class="post-meta-info-taxonomy">
                    
                    
                    using tags:
                        <a href="/tags/ranger">ranger</a>, <a href="/tags/pathfinder">pathfinder</a>
                </span>
            </div>
        </div>
    </div>
</article>

        
            <article class="post u-cf">
    <div class="row">
        <div class="twelve columns">
            <h1 class="post-title">Infrastructure and System Monitoring using Prometheus</h1>
        </div>
    </div>
    <div class="row">
        <div class="twelve columns">
            <p>Last week I was lucky enough to host a talk during the Devoxx (UK) on the subject of &ldquo;Infrastructure and System Monitoring using Prometheus&rdquo;. You can find the used material here:</p>
<ul>
<li>Slides: <a href="https://speakerdeck.com/mpas/infrastructure-and-system-monitoring-using-prometheus">https://speakerdeck.com/mpas/infrastructure-and-system-monitoring-using-prometheus</a></li>
<li>Slides in PDF: <a href="https://drive.google.com/open?id=0Byx7lFSXlDU0TkJ1ZUZqdjU4MFE">https://drive.google.com/open?id=0Byx7lFSXlDU0TkJ1ZUZqdjU4MFE</a></li>
<li>Code: <a href="https://github.com/mpas/infrastructure-and-system-monitoring-using-prometheus">https://github.com/mpas/infrastructure-and-system-monitoring-using-prometheus</a></li>
</ul>
<p>Feel free to share and distribute</p>

        </div>
    </div>
    <div class="row">
        <div class="twelve columns">
            <div class="post-meta-info">
                Published on
                
                    2017-05-12
                
                <span class="post-meta-info-taxonomy">
                    
                    
                    using tags:
                        <a href="/tags/infrastructure">infrastructure</a>, <a href="/tags/monitoring">monitoring</a>, <a href="/tags/docker">docker</a>, <a href="/tags/prometheus">prometheus</a>, <a href="/tags/talks">talks</a>, <a href="/tags/devoxx">devoxx</a>
                </span>
            </div>
        </div>
    </div>
</article>

        
            <article class="post u-cf">
    <div class="row">
        <div class="twelve columns">
            <h1 class="post-title">Dockerize your Grails application</h1>
        </div>
    </div>
    <div class="row">
        <div class="twelve columns">
            <p>Ever wanted to create a Docker image that contains your Grails application? You are lucky! It is easy to do so..</p>
<p>Let us first create a new Grails application. In the example we will create a basic application using the rest-profile.</p>
<p><strong>Prerequisite</strong> : Docker is installed on your machine.</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">$ grails create-app docker-test --profile rest-api
</code></pre></div><p>After the Grails application has been created, we will need to add the following files to our project.</p>
<ul>
<li>Dockerfile (determines what our Docker image will contain)</li>
<li>docker-entrypoint.sh (script that is responsible for starting our Grails application)</li>
</ul>
<div class="highlight"><pre class="chroma"><code class="language-Dockerfile" data-lang="Dockerfile">// file: /src/main/docker/Dockerfile<span class="err">
</span><span class="err">
</span><span class="err"></span><span class="k">FROM</span><span class="s"> openjdk:latest</span><span class="err">
</span><span class="err">
</span><span class="err"></span><span class="c"># set environment options</span><span class="err">
</span><span class="err"></span><span class="k">ENV</span> <span class="nv">JAVA_OPTS</span><span class="o">=</span><span class="s2">&#34;-Xms64m -Xmx256m -XX:MaxMetaspaceSize=128m&#34;</span><span class="err">
</span><span class="err">
</span><span class="err"></span><span class="k">RUN</span> mkdir -p /app<span class="err">
</span><span class="err"></span><span class="k">WORKDIR</span><span class="s"> /app</span><span class="err">
</span><span class="err">
</span><span class="err"></span><span class="k">COPY</span> /app/application.jar application.jar<span class="err">
</span><span class="err"></span><span class="k">COPY</span> /app/docker-entrypoint.sh docker-entrypoint.sh<span class="err">
</span><span class="err">
</span><span class="err"></span><span class="c"># Set file permissions</span><span class="err">
</span><span class="err"></span><span class="k">RUN</span> chmod +x /app/docker-entrypoint.sh<span class="err">
</span><span class="err">
</span><span class="err"></span><span class="c"># Set start script as enrypoint</span><span class="err">
</span><span class="err"></span><span class="k">ENTRYPOINT</span> <span class="p">[</span><span class="s2">&#34;./docker-entrypoint.sh&#34;</span><span class="p">]</span><span class="err">
</span></code></pre></div><div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">// file: /src/main/docker/app/docker-entrypoint.sh
<span class="c1">#!/bin/bash</span>
<span class="nb">set</span> -e

<span class="nb">exec</span> java <span class="si">${</span><span class="nv">JAVA_OPTS</span><span class="si">}</span> -jar application.jar <span class="nv">$@</span>
<span class="c1"># exec java ${JAVA_OPTS} -Dserver.port=${SERVER_PORT} -jar application.jar $@</span>
</code></pre></div><p>Next step is to add the tasks to our <code>build.gradle</code> so it can generate the Docker image.</p>
<p>So add the following snippet to your <code>build.gradle</code> file!</p>
<div class="highlight"><pre class="chroma"><code class="language-groovy" data-lang="groovy"><span class="c1">// file: /build.gradle
</span><span class="c1"></span><span class="n">String</span> <span class="nf">getDockerImageName</span><span class="o">()</span> <span class="o">{</span>
  <span class="s2">&#34;docker-test&#34;</span>
<span class="o">}</span>

<span class="n">task</span> <span class="nf">buildDockerImage</span><span class="o">(</span><span class="nl">type:</span><span class="n">Exec</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">group</span> <span class="o">=</span> <span class="s1">&#39;docker&#39;</span>
    <span class="n">description</span> <span class="o">=</span> <span class="s1">&#39;Build a docker image&#39;</span>
    <span class="n">commandLine</span> <span class="s1">&#39;docker&#39;</span><span class="o">,</span> <span class="s1">&#39;build&#39;</span><span class="o">,</span> <span class="s1">&#39;-f&#39;</span><span class="o">,</span> <span class="s1">&#39;build/docker/Dockerfile&#39;</span><span class="o">,</span> <span class="s1">&#39;-t&#39;</span><span class="o">,</span> <span class="s2">&#34;${dockerImageName}&#34;</span><span class="o">,</span> <span class="s1">&#39;build/docker&#39;</span>

    <span class="n">doFirst</span> <span class="o">{</span>
        <span class="n">println</span> <span class="s2">&#34;&gt;&gt; Creating image: ${dockerImageName}&#34;</span>
        <span class="cm">/* copy the generate war file to /build/docker/app */</span>
        <span class="n">copy</span> <span class="o">{</span>
            <span class="n">from</span> <span class="n">war</span><span class="o">.</span><span class="na">archivePath</span>
            <span class="n">into</span> <span class="s1">&#39;build/docker/app/&#39;</span>
        <span class="o">}</span>
        <span class="cm">/* copy artifacts from src/main/docker/app into the build/docker/app */</span>
        <span class="n">copy</span> <span class="o">{</span>
            <span class="n">from</span> <span class="s1">&#39;src/main/docker/app/&#39;</span>
            <span class="n">into</span> <span class="s1">&#39;build/docker/app&#39;</span>
        <span class="o">}</span>
        <span class="cm">/* copy Dockerfile from src/main/docker into the build/docker */</span>
        <span class="n">copy</span> <span class="o">{</span>
            <span class="n">from</span><span class="o">(</span><span class="s1">&#39;src/main/docker/&#39;</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">include</span> <span class="s1">&#39;Dockerfile&#39;</span>
            <span class="o">}</span>
            <span class="n">into</span> <span class="s1">&#39;build/docker&#39;</span>
        <span class="o">}</span>
        <span class="cm">/* rename war file to application.jar */</span>
        <span class="n">file</span><span class="o">(</span><span class="s2">&#34;build/docker/app/${war.archiveName}&#34;</span><span class="o">).</span><span class="na">renameTo</span><span class="o">(</span><span class="s2">&#34;build/docker/app/application.jar&#34;</span><span class="o">)</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div><p>Now that we have everyting in place we can build the image and start the container,</p>
<p>Create the docker image using assemble target and buildDockerImage</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">$ ./gradlew assemble buildDockerImage
</code></pre></div><p>Run a container based on the previous created image</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">$ docker run -it --rm -p 8080:8080 docker-test
</code></pre></div><p>This will run the container in interactive mode (<code>-it</code>) and the container will be removed when we stop the container (<code>--rm</code>). Port 8080 in the container will be available on port 8080 on your host system (<code>-p 8080:8080</code>).</p>
<p>This will run the specified container and the endpoint will be available using your browser. Just visit http://localhost:8080</p>

        </div>
    </div>
    <div class="row">
        <div class="twelve columns">
            <div class="post-meta-info">
                Published on
                
                    2016-11-25
                
                <span class="post-meta-info-taxonomy">
                    
                    
                    using tags:
                        <a href="/tags/grails">grails</a>, <a href="/tags/docker">docker</a>
                </span>
            </div>
        </div>
    </div>
</article>

        
            <article class="post u-cf">
    <div class="row">
        <div class="twelve columns">
            <h1 class="post-title">Creating/Pushing Docker images using Gradle without plugins</h1>
        </div>
    </div>
    <div class="row">
        <div class="twelve columns">
            <p>In our current project we where heavily focussed on the usage of Gradle plugins to create Docker images. We used plugins to create the images and push them to our AWS ECR repositories. When using these plugins we hit various bugs related to the fact that not all developers where using Linux operating systems to test our their containers. At the end we took a look on how we could create those images without using additional plugins.</p>
<p><strong>Prerequisite</strong> : Docker is installed on your machine.</p>
<h2 id="creating-an-image">Creating an image</h2>
<p>The following snippet will create a Docker image using the task <code>gradle buildDockerImage</code></p>
<pre><code>- application layout
| build.gradle
| &gt; src
| &gt;- main
| &gt;-- docker (contains a Dockerfile)
| &gt;--- app (contains data that can be used in your Dockerfile)
</code></pre>
<div class="highlight"><pre class="chroma"><code class="language-groovy" data-lang="groovy"><span class="cm">/*
</span><span class="cm">    You can put some logic in the getDockerImageName to determine how your
</span><span class="cm">    Docker image should be created.
</span><span class="cm">*/</span>
<span class="n">String</span> <span class="nf">getDockerImageName</span><span class="o">()</span> <span class="o">{</span>
  <span class="s2">&#34;my-first-docker-image&#34;</span>
<span class="o">}</span>

<span class="cm">/*
</span><span class="cm">    Execute a docker build using commandline pointing to our Dockerfile that
</span><span class="cm">    has been copied to /build/docker/.
</span><span class="cm">*/</span>
<span class="n">task</span> <span class="nf">buildDockerImage</span><span class="o">(</span><span class="nl">type:</span><span class="n">Exec</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">group</span> <span class="o">=</span> <span class="s1">&#39;docker&#39;</span>
    <span class="n">description</span> <span class="o">=</span> <span class="s1">&#39;Build a docker image&#39;</span>
    <span class="n">commandLine</span> <span class="s1">&#39;docker&#39;</span><span class="o">,</span> <span class="s1">&#39;build&#39;</span><span class="o">,</span> <span class="s1">&#39;-f&#39;</span><span class="o">,</span> <span class="s1">&#39;build/docker/Dockerfile&#39;</span><span class="o">,</span> <span class="s1">&#39;-t&#39;</span><span class="o">,</span> <span class="s2">&#34;${dockerImageName}&#34;</span><span class="o">,</span> <span class="s1">&#39;build/docker&#39;</span>

    <span class="n">doFirst</span> <span class="o">{</span>
        <span class="n">println</span> <span class="s2">&#34;&gt;&gt; Creating image: ${dockerImageName}&#34;</span>
        <span class="cm">/* copy artifacts from src/main/docker/app into the build/docker/app */</span>
        <span class="n">copy</span> <span class="o">{</span>
            <span class="n">from</span> <span class="s1">&#39;src/main/docker/app/&#39;</span>
            <span class="n">into</span> <span class="s1">&#39;build/docker/app&#39;</span>
        <span class="o">}</span>
        <span class="cm">/* copy Dockerfile from src/main/docker into the build/docker */</span>
        <span class="n">copy</span> <span class="o">{</span>
            <span class="n">from</span><span class="o">(</span><span class="s1">&#39;src/main/docker/&#39;</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">include</span> <span class="s1">&#39;Dockerfile&#39;</span>
            <span class="o">}</span>
            <span class="n">into</span> <span class="s1">&#39;build/docker&#39;</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div><h2 id="pushing-an-image">pushing an image</h2>
<p>Pushing an image without using plugins is just as easy.</p>
<div class="highlight"><pre class="chroma"><code class="language-groovy" data-lang="groovy"><span class="n">pushDockerImage</span><span class="o">(</span><span class="nl">type:</span> <span class="n">Exec</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">group</span> <span class="o">=</span> <span class="s1">&#39;docker&#39;</span>
    <span class="n">description</span> <span class="o">=</span> <span class="s1">&#39;Push a docker image&#39;</span>
    <span class="n">commandLine</span> <span class="s1">&#39;docker&#39;</span><span class="o">,</span> <span class="s1">&#39;push&#39;</span><span class="o">,</span> <span class="s2">&#34;${dockerImageName}&#34;</span>

    <span class="n">doFirst</span> <span class="o">{</span>
        <span class="n">println</span> <span class="s2">&#34;&gt;&gt; Pushing image: ${dockerImageName}&#34;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div><p>Using this approach without using unneeded Gradle plugins resulted in a an easy way to create containers on different platforms.</p>

        </div>
    </div>
    <div class="row">
        <div class="twelve columns">
            <div class="post-meta-info">
                Published on
                
                    2016-11-24
                
                <span class="post-meta-info-taxonomy">
                    
                    
                    using tags:
                        <a href="/tags/docker">docker</a>, <a href="/tags/gradle">gradle</a>, <a href="/tags/groovy">groovy</a>
                </span>
            </div>
        </div>
    </div>
</article>

        
            <article class="post u-cf">
    <div class="row">
        <div class="twelve columns">
            <h1 class="post-title">Identifying Docker container outage using Prometheus</h1>
        </div>
    </div>
    <div class="row">
        <div class="twelve columns">
            <p><a href="https://prometheus.io/">Prometheus</a> is a an open-source monitoring system with a dimensional data model, flexible query language, efficient time series database and modern alerting approach.</p>
<p>Metric data is <strong>pulled</strong> (on a regular time-interval) from so called exporters which expose the metrics coming from applications/operating systems etc..</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">+------------------+                               +----------+     Visualize data
|  +------------+  |                               | Grafana  +---&gt; coming from
|  | Dockerized |  |                               +----+-----+     Prometheus
|  | Application|  |                                    |
|  +------------+  |                                    ^
|  +------------+  |  Pull data   +----------+          |
|  |  CAdvisor  +---------&gt;-------+Prometheus+----------+
|  +------------+  |              +---------++
|                  |                        |
| Operating System |                        |
|       with       |                        |
| Docker installed |                        |
|                  |                        v
+------------------+           Prometheus collects data
                               coming from remote systems
</code></pre></div><p>In the diagram above cAdvisor is a so called exporter. There are other exporters like e.g. <a href="https://github.com/prometheus/node_exporter">Node Exporter</a> that exposes machine metrics. <strong>cAdvisor</strong> is used to get Docker container metrics.</p>
<h2 id="cadvisor">cAdvisor</h2>
<p><a href="https://github.com/google/cadvisor">cAdvisor</a> is a project coming from Google and analyzes resource usage and performance characteristics of running Docker  containers! When running a Dockerized application and starting a cAdvisor container you will have instant metrics available for all running containers.</p>
<p>A lot of metrics are exposed by cAdvisor of which one is the metric <code>container_last_seen</code>. You can use this metric in Prometheus to identify if a container has left the building :) The challenge with Prometheus is that it keeps the data for a specific amount of time the so called <code>Stale Timeout</code>. This means that Prometheus will keep reporting back that the data has been received until this timeout has occurred (default 5 minutes). This is of course too much if we need to identify if a container has gone.</p>
<p>So if you would normally query like this:</p>
<div class="highlight"><pre class="chroma"><code class="language-sql" data-lang="sql"><span class="k">count</span><span class="p">(</span><span class="n">container_last_seen</span><span class="err">{</span><span class="n">job</span><span class="o">=</span><span class="s2">&#34;&lt;jobname&gt;&#34;</span><span class="p">,</span><span class="n">name</span><span class="o">=~</span><span class="s2">&#34;.*&lt;containername&gt;.*&#34;</span><span class="err">}</span><span class="p">)</span>
</code></pre></div><p>This would get results until 5 minutes.. way to far&hellip;</p>
<p>A simple alternate query to identify if the container has gone is like below:</p>
<div class="highlight"><pre class="chroma"><code class="language-sql" data-lang="sql"><span class="k">count</span><span class="p">(</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">container_last_seen</span><span class="err">{</span><span class="n">job</span><span class="o">=</span><span class="s2">&#34;&lt;jobname&gt;&#34;</span><span class="p">,</span><span class="n">name</span><span class="o">=~</span><span class="s2">&#34;.*&lt;containername&gt;.*&#34;</span><span class="err">}</span> <span class="o">&lt;</span> <span class="mi">30</span><span class="p">)</span> <span class="k">OR</span> <span class="n">vector</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</code></pre></div><p>The &lsquo;30&rsquo; is the time in seconds before we want to be notified if a container has gone. This time has to be larger then the pull interval for your job.</p>
<p>When using the mentioned query you can create a nice <a href="http://docs.grafana.org/reference/singlestat/">Singlestat</a> panel in Grafan so you can display an alert when the container is gone.</p>

        </div>
    </div>
    <div class="row">
        <div class="twelve columns">
            <div class="post-meta-info">
                Published on
                
                    2016-11-17
                
                <span class="post-meta-info-taxonomy">
                    
                    
                    using tags:
                        <a href="/tags/prometheus">prometheus</a>, <a href="/tags/docker">docker</a>, <a href="/tags/cadvisor">cadvisor</a>
                </span>
            </div>
        </div>
    </div>
</article>

        
            <article class="post u-cf">
    <div class="row">
        <div class="twelve columns">
            <h1 class="post-title">Building a Consul cluster using Terraform/AWS</h1>
        </div>
    </div>
    <div class="row">
        <div class="twelve columns">
            <!-- raw HTML omitted -->
<ul>
<li>Service Discovery</li>
<li>Health Checking</li>
<li>Key/Value Store</li>
<li>Multi Datacenter</li>
</ul>
<p>For more information on <a href="http://Consul.io">Consul</a> itself please have a look in the excellent documentation.</p>
<ul>
<li><a href="https://www.consul.io/intro/index.html">Consul Intro</a></li>
<li><a href="https://www.consul.io/docs/index.html">Consul documentation</a></li>
</ul>
<h2 id="is-it-really-easy">Is it really easy?</h2>
<p>Setting up a <a href="http://Consul.io">Consul</a> cluster seems easy, just follow the many tutorials out there and you will have a Consul cluster running in a few steps on your local machine&hellip;</p>
<p>But hey.. <strong>what if you need to deploy this cluster on an AWS environment? How do
you create the cluster and how can you make sure it is always available?</strong></p>
<p>This simple write up is just an example to give you an idea how this Consul cluster can be created and provisioned by using Terraform only. The goal is to have a cluster using the official Docker images provided by Consul itself running on EC2 nodes.</p>
<h2 id="creating-a-consul-cluster">Creating a Consul cluster</h2>
<p>The principle is not that hard&hellip; Consul nodes can discover each other based on IP Address. If you feed the Consul cluster members with IP Addresses that are part of the cluster you are good to go. In the example case we are going to start a number of Consul cluster members. The first node will be unable to form a cluster but if the second node starts up it will get the ip from the first node and the the first node will then know the ip of the second one.. etc.. So if you start up more than 2 nodes you will be good to go.</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">+------+   +------+  +------+  +------+  +------+
|Consul|   |Consul|  |Consul|  |Consul|  |Consul|
|Node 1|   |Node 2|  |Node 3|  |Node 4|  |Node n|
+------+   +------+  +------+  +------+  +------+
    &lt; Find each other based on ip address &gt;
</code></pre></div><p>The power is in the user-data script that is used for bootstrapping the Consul cluster nodes. In the example case they will find each other based on a query using <code>aws ec2 describe-instances</code> that will find nodes with a specific name, and from those identified nodes we will extract the IP Addresses that will be used to joint the Consul cluster. You can always modify the query to your own needs off course. The user-data script is used in the launch configuration.</p>
<p>So enough talk&hellip; lets start :)</p>
<p><strong>The given examples are intentionally kept simple!! So you will need to tweak your Terraform code according to your needs</strong></p>
<h2 id="step-1-define-a-launch-configuration">Step 1: Define a launch Configuration</h2>
<p>The core component of our Consul cluster is the launch configuration. This launch configuration determines what user-data file needs to be executed when launching a new instance.</p>
<div class="highlight"><pre class="chroma"><code class="language-terraform" data-lang="terraform"><span class="kr">resource</span> <span class="s2">&#34;aws_launch_configuration&#34;</span> <span class="s2">&#34;consul-cluster&#34;</span> <span class="p">{</span>

  <span class="cm">/*
</span><span class="cm">    in this case we use a docker optimized ami, because we are going
</span><span class="cm">    to use the official Consul docker image as a starter.
</span><span class="cm">    You can always use an ami on which you install docker manually!
</span><span class="cm">  */</span>
  <span class="na">image_id</span>  = <span class="s2">&#34;docker-optimized-ami-0123456789&#34;</span>

  <span class="cm">/*
</span><span class="cm">    the user-data script that holds the magic
</span><span class="cm">  */</span>
  <span class="na">user_data</span> = <span class="s2">&#34;</span><span class="si">${</span><span class="nb">data</span><span class="p">.</span><span class="nx">template_file</span><span class="p">.</span><span class="nx">consul</span><span class="o">-</span><span class="nx">cluster</span><span class="p">.</span><span class="nx">rendered</span><span class="si">}</span><span class="s2">&#34;</span>
  <span class="na">instance_type</span> = <span class="s2">&#34;t2.micro&#34;</span>

  <span class="cm">/*
</span><span class="cm">    make sure you open the correct ports so the Consul nodes can
</span><span class="cm">    discover each other the actual security group is not shown
</span><span class="cm">  */</span>
  <span class="na">security_groups</span> = <span class="p">[</span><span class="s2">&#34;sg-0123456789&#34;</span><span class="p">]</span>
  <span class="na">key_name</span> = <span class="nx">your</span><span class="o">-</span><span class="nx">deploy</span><span class="o">-</span><span class="nx">key</span>

  <span class="cm">/*
</span><span class="cm">    us a policy which grants read access to the EC2 api
</span><span class="cm">  */</span>
  <span class="na">iam_instance_profile</span> = <span class="s2">&#34;arn:aws:iam::0123456789:read_ec2_policy/ec2&#34;</span>
<span class="p">}</span>

<span class="cm">/*
</span><span class="cm">    The template file used for the user-data
</span><span class="cm">*/</span>
<span class="kr">data</span> <span class="s2">&#34;template_file&#34;</span> <span class="s2">&#34;consul-cluster&#34;</span> <span class="p">{</span>
  <span class="na">template</span> = <span class="s2">&#34;user-data-consul-cluster.tpl&#34;</span><span class="p">)}</span><span class="s2">&#34;
</span><span class="s2">  vars {
</span><span class="s2">    // the name must match the Name tag of the autoscaling group
</span><span class="s2">    consul_cluster_name = &#34;</span><span class="nx">consul</span><span class="o">-</span><span class="nx">cluster</span><span class="o">-</span><span class="nx">member</span><span class="s2">&#34;
</span><span class="s2">
</span><span class="s2">    // the number of instances that need to be in the cluster to be healthy
</span><span class="s2">    consul_cluster_min_size = 3
</span><span class="s2">  }
</span><span class="s2">}
</span></code></pre></div><h2 id="step-2-create-the-template-file">Step 2: Create the template file</h2>
<p>The user-data file is going to query AWS using the aws describe-instances api and will return ec2 nodes that have a matching name using the --filters option. <code>'Name=tag:Name,Values=${consul_cluster_name}'</code></p>
<p>All the retrieved instances are then queried for their private ip and the values are stored in a list. After completing the list the instance ip for the current machine is removed.</p>
<p>A Consul specific join string is composed and provided to the docker image. This enables the Consul docker image to check for available servers when starting.</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">// File: user-data-consul-cluster.tpl

<span class="c1">#!/bin/bash -ex</span>
<span class="nb">exec</span> &gt; &gt;<span class="o">(</span>tee /var/log/user-data.log<span class="p">|</span>logger -t user-data -s 2&gt;/dev/console<span class="o">)</span> 2&gt;<span class="p">&amp;</span><span class="m">1</span>

<span class="nb">echo</span> <span class="s1">&#39;installing additional software&#39;</span>
<span class="k">for</span> i in <span class="o">{</span>1..5<span class="o">}</span>
<span class="k">do</span>
    yum install -y aws-cli <span class="o">&amp;&amp;</span> <span class="nb">break</span> <span class="o">||</span> sleep <span class="m">120</span>
<span class="k">done</span>

<span class="c1">################################################################################</span>
<span class="c1"># Running Consul</span>
<span class="c1">################################################################################</span>
<span class="c1"># get current instance ip</span>
<span class="nv">INSTANCE_IP</span><span class="o">=</span><span class="k">$(</span>curl http://169.254.169.254/latest/meta-data/local-ipv4<span class="k">)</span>

<span class="c1"># get list of available Consul servers; based on Name (value) tag!</span>
<span class="nv">IP_LIST</span><span class="o">=</span><span class="k">$(</span>aws ec2 describe-instances --region us-east-1 <span class="se">\
</span><span class="se"></span>--filters <span class="s1">&#39;Name=tag:Name,Values=${consul_cluster_name}&#39;</span> <span class="se">\
</span><span class="se"></span><span class="s1">&#39;Name=instance-state-name,Values=running&#39;</span> <span class="se">\
</span><span class="se"></span>--query <span class="s2">&#34;Reservations[*].Instances[*].PrivateIpAddress&#34;</span> <span class="se">\
</span><span class="se"></span>--output<span class="o">=</span>text<span class="k">)</span>

<span class="c1"># remove the current instance ip from the list of available servers</span>
<span class="nv">IP_LIST</span><span class="o">=</span><span class="s2">&#34;</span><span class="nv">$$</span><span class="s2">{IP_LIST/</span><span class="nv">$$</span><span class="s2">INSTANCE_IP/}&#34;</span>

<span class="c1"># remove duplicated spaces, \r\n and replace space by &#39;,&#39;</span>
<span class="nv">IP_LIST</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span> <span class="nv">$$</span>IP_LIST <span class="p">|</span> tr -s <span class="s2">&#34; &#34;</span> <span class="p">|</span> tr -d <span class="s1">&#39;\r\n&#39;</span> <span class="p">|</span> tr -s <span class="s1">&#39; &#39;</span> <span class="s1">&#39;,&#39;</span><span class="k">)</span>

<span class="c1"># create join string</span>
<span class="k">for</span> i in <span class="k">$(</span><span class="nb">echo</span> <span class="nv">$IP_LIST</span> <span class="p">|</span> sed <span class="s2">&#34;s/,/ /g&#34;</span><span class="k">)</span>
<span class="k">do</span>
    <span class="nv">JOIN_STRING</span><span class="o">+=</span><span class="s2">&#34;-retry-join </span><span class="nv">$i</span><span class="s2"> &#34;</span>
<span class="k">done</span>

<span class="c1"># - run Consul</span>
docker run -d --net<span class="o">=</span>host <span class="se">\
</span><span class="se"></span>-e <span class="s1">&#39;CONSUL_LOCAL_CONFIG={&#34;skip_leave_on_interrupt&#34;: true}&#39;</span> <span class="se">\
</span><span class="se"></span>--name consul-server consul:latest <span class="se">\
</span><span class="se"></span>agent -server -bind<span class="o">=</span><span class="nv">$INSTANCE_IP</span> <span class="nv">$JOIN_STRING</span> <span class="se">\
</span><span class="se"></span>-bootstrap-expect<span class="o">=</span><span class="si">${</span><span class="nv">consul_cluster_min_size</span><span class="si">}</span> -ui -client 0.0.0.0
<span class="c1"># ------------------------------------------------------------------------------</span>
</code></pre></div><h2 id="step-3-create-an-autoscaling-group">Step 3: Create an autoscaling group</h2>
<div class="highlight"><pre class="chroma"><code class="language-terraform" data-lang="terraform"><span class="cm">/*
</span><span class="cm">    creates an autoscaling group so servers are created when needed
</span><span class="cm">*/</span>
<span class="kr">resource</span> <span class="s2">&#34;aws_autoscaling_group&#34;</span> <span class="s2">&#34;consul-cluster&#34;</span> <span class="p">{</span>
  <span class="na">min_size</span> = <span class="m">3</span>
  <span class="na">max_size</span> = <span class="m">5</span>
  <span class="na">desired_capacity</span> = <span class="m">3</span>
  <span class="na">min_elb_capacity</span> = <span class="m">3</span>

  <span class="na">launch_configuration</span> = <span class="s2">&#34;</span><span class="si">${</span><span class="nx">aws_launch_configuration</span><span class="p">.</span><span class="nx">consul</span><span class="o">-</span><span class="nx">cluster</span><span class="p">.</span><span class="nx">name</span><span class="si">}</span><span class="s2">&#34;</span>
  <span class="na">load_balancers</span> = <span class="p">[</span><span class="s2">&#34;</span><span class="si">${</span><span class="nx">aws_elb</span><span class="p">.</span><span class="nx">consul</span><span class="p">.</span><span class="nx">id</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">]</span>

  <span class="nx">tag</span> <span class="p">{</span>
    <span class="na">key</span> = <span class="s2">&#34;Name&#34;</span>
    <span class="cm">/*
</span><span class="cm">      note: this is the value that is being searched for in the user-data
</span><span class="cm">    */</span>
    <span class="na">value</span> = <span class="s2">&#34;consul-cluster-member&#34;</span>
    <span class="na">propagate_at_launch</span> = <span class="kc">true</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div><h2 id="step-4-create-an-elb-as-frontend-for-the-consul-cluster">Step 4: Create an ELB as frontend for the Consul cluster</h2>
<div class="highlight"><pre class="chroma"><code class="language-terraform" data-lang="terraform"><span class="kr">resource</span> <span class="s2">&#34;aws_elb&#34;</span> <span class="s2">&#34;consul-cluster&#34;</span> <span class="p">{</span>
  <span class="na">name</span> = <span class="s2">&#34;consul-cluster&#34;</span>
  <span class="na">subnets</span> = <span class="p">[</span><span class="s2">&#34;sn-0123456789&#34;</span><span class="p">]</span>
  <span class="na">security_groups</span> = <span class="p">[</span><span class="s2">&#34;sg-0123456789&#34;</span><span class="p">]</span>

  <span class="nx">listener</span> <span class="p">{</span>
    <span class="na">instance_port</span> = <span class="m">8300</span>
    <span class="na">instance_protocol</span> = <span class="s2">&#34;tcp&#34;</span>
    <span class="na">lb_port</span> = <span class="m">8300</span>
    <span class="na">lb_protocol</span> = <span class="s2">&#34;tcp&#34;</span>
  <span class="p">}</span>

  <span class="nx">listener</span> <span class="p">{</span>
    <span class="na">instance_port</span> = <span class="m">8301</span>
    <span class="na">instance_protocol</span> = <span class="s2">&#34;tcp&#34;</span>
    <span class="na">lb_port</span> = <span class="m">8301</span>
    <span class="na">lb_protocol</span> = <span class="s2">&#34;tcp&#34;</span>
  <span class="p">}</span>

  <span class="nx">listener</span> <span class="p">{</span>
    <span class="na">instance_port</span> = <span class="m">8302</span>
    <span class="na">instance_protocol</span> = <span class="s2">&#34;tcp&#34;</span>
    <span class="na">lb_port</span> = <span class="m">8302</span>
    <span class="na">lb_protocol</span> = <span class="s2">&#34;tcp&#34;</span>
  <span class="p">}</span>

  <span class="nx">listener</span> <span class="p">{</span>
    <span class="na">instance_port</span> = <span class="m">8400</span>
    <span class="na">instance_protocol</span> = <span class="s2">&#34;tcp&#34;</span>
    <span class="na">lb_port</span> = <span class="m">8400</span>
    <span class="na">lb_protocol</span> = <span class="s2">&#34;tcp&#34;</span>
  <span class="p">}</span>

  <span class="nx">listener</span> <span class="p">{</span>
    <span class="na">instance_port</span> = <span class="m">8500</span>
    <span class="na">instance_protocol</span> = <span class="s2">&#34;http&#34;</span>
    <span class="na">lb_port</span> = <span class="m">8500</span>
    <span class="na">lb_protocol</span> = <span class="s2">&#34;http&#34;</span>
  <span class="p">}</span>

  <span class="nx">listener</span> <span class="p">{</span>
    <span class="na">instance_port</span> = <span class="m">8600</span>
    <span class="na">instance_protocol</span> = <span class="s2">&#34;tcp&#34;</span>
    <span class="na">lb_port</span> = <span class="m">8600</span>
    <span class="na">lb_protocol</span> = <span class="s2">&#34;tcp&#34;</span>
  <span class="p">}</span>

  <span class="nx">health_check</span> <span class="p">{</span>
    <span class="na">target</span> = <span class="s2">&#34;HTTP:8500/v1/status/leader&#34;</span>
    <span class="na">healthy_threshold</span> = <span class="m">2</span>
    <span class="na">unhealthy_threshold</span> = <span class="m">2</span>
    <span class="na">interval</span> = <span class="m">30</span>
    <span class="na">timeout</span> = <span class="m">5</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div><p>When putting all the pieces together you should now have a running Consul cluster!</p>

        </div>
    </div>
    <div class="row">
        <div class="twelve columns">
            <div class="post-meta-info">
                Published on
                
                    2016-11-16
                
                <span class="post-meta-info-taxonomy">
                    
                    
                    using tags:
                        <a href="/tags/consul">consul</a>, <a href="/tags/terraform">terraform</a>, <a href="/tags/aws">aws</a>
                </span>
            </div>
        </div>
    </div>
</article>

        
            <article class="post u-cf">
    <div class="row">
        <div class="twelve columns">
            <h1 class="post-title">Change the port of actuator endpoint in a Grails application</h1>
        </div>
    </div>
    <div class="row">
        <div class="twelve columns">
            <p>When using actuator endpoints to expose metrics in a Grails (Spring Boot) application,
it may be useful to run the metrics on a different port.</p>
<p>This enables you to hide the metrics for the public and use the different port in
an AWS infrastucture so that the metrics are only available internal.</p>
<p>Let us first enable the actuator endpoints</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">// File: grails-app/conf/application.yml

# Spring Actuator Endpoints are Disabled by Default
endpoints:
    enabled: true
    jmx:
        enabled: true
</code></pre></div><p>Change the port on which the metrics runs, add the lines below to the appl</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">// File: grails-app/conf/application.yml

management:
    port: 9000
</code></pre></div><p>Now when you start your Grails application it run on port <code>8080</code> and the metrics
are available on port <code>9090</code>/metrics</p>

        </div>
    </div>
    <div class="row">
        <div class="twelve columns">
            <div class="post-meta-info">
                Published on
                
                    2016-11-02
                
                <span class="post-meta-info-taxonomy">
                    
                    
                    using tags:
                        <a href="/tags/grails">grails</a>, <a href="/tags/springboot">springboot</a>
                </span>
            </div>
        </div>
    </div>
</article>

        
            <article class="post u-cf">
    <div class="row">
        <div class="twelve columns">
            <h1 class="post-title">Accessing localhost from a Docker Container using native Docker for Mac</h1>
        </div>
    </div>
    <div class="row">
        <div class="twelve columns">
            <p>Ever had a need to access something from within a <a href="https://www.docker.com/">Docker</a> container that runs on the host system?</p>
<p>When using native Docker on OSX you have bad luck. When configuring a container and pointing that to localhost will result in the fact the your software will be targeted at the localhost of the docker container.</p>
<p>A solution for this isto define a new local loopback to your localhost</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell">$ sudo ifconfig lo0 <span class="nb">alias</span> 172.16.123.1
</code></pre></div><p>This will define a loopback network interface that points to your localhost. When you need to access the localhost you can use this ip.</p>

        </div>
    </div>
    <div class="row">
        <div class="twelve columns">
            <div class="post-meta-info">
                Published on
                
                    2016-11-01
                
                <span class="post-meta-info-taxonomy">
                    
                    
                    using tags:
                        <a href="/tags/docker">docker</a>, <a href="/tags/osx">osx</a>, <a href="/tags/mac">mac</a>
                </span>
            </div>
        </div>
    </div>
</article>

        
            <article class="post u-cf">
    <div class="row">
        <div class="twelve columns">
            <h1 class="post-title">Terraform to the rescue</h1>
        </div>
    </div>
    <div class="row">
        <div class="twelve columns">
            <p>Getting exposed to <a href="https://aws.amazon.com/">Amazon Web Services</a> is fun! Certainly when you see that the infrastructure is growing and supporting the daily need of developers and the business. You slowly start adding services and try to keep everything in a state so that it is repeatable and maintainable. At a certain moment it becomes clear that you need the concept of <a href="https://en.wikipedia.org/wiki/Infrastructure_as_Code">Infrastructure As Code</a>.</p>
<p>The Amazon way of doing this is by using <a href="https://aws.amazon.com/cloudformation/">AWS CloudFormation</a>. This enables you to define the infrastructure in a JSON/YAML format and apply the changes to the infrastructure.</p>
<p>Our team manages a bunch of environments using services like AWS ECS, EC2, ElasticSearch, RDS and more.. Maintaining this infrastructure in CloudFormation seemed the standard way of doing things until we started a proof-of-concept with <a href="https://www.terraform.io/">Terraform</a>.</p>
<p><strong>Why did we start this proof-of-concept??</strong> Mainly because the overwhelming pieces of code that we needed to maintain in CloudFormation became unmaintainable. The use of Terraform was so successful that we decide to rewrite our entire infrastructure codebase using Terraform.</p>
<p>The advantages when using Terraform are:</p>
<ul>
<li>less code to maintain because Terraform is less verbose</li>
<li>when using Terraform an infrastructure change can be planned, this shows what is going to be changed before actually executing the change</li>
</ul>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">$ terraform plan
</code></pre></div><p>See what the changes are and then when everything seems ok&hellip;</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">$ terraform apply
</code></pre></div><p>Currently we have our entire Infrastructure in Terraform and we could never be more happier. Terraform came to our rescue!</p>

        </div>
    </div>
    <div class="row">
        <div class="twelve columns">
            <div class="post-meta-info">
                Published on
                
                    2016-10-09
                
                <span class="post-meta-info-taxonomy">
                    
                    
                    using tags:
                        <a href="/tags/devops">devops</a>, <a href="/tags/aws">aws</a>, <a href="/tags/terraform">terraform</a>
                </span>
            </div>
        </div>
    </div>
</article>

        
            <article class="post u-cf">
    <div class="row">
        <div class="twelve columns">
            <h1 class="post-title">Functional Rest API Testing with Grails/Rest Client Builder</h1>
        </div>
    </div>
    <div class="row">
        <div class="twelve columns">
            <p>Functional Rest API testing with Grails is easy and fun. We will be creating a simple Rest Controller and test it using Spock and Rest Client Builder.</p>
<p>When running the functional test a real container will be started on a specific port and tests are run against the running container. Just as it should be.</p>
<p>**Scenario:**<!-- raw HTML omitted -->
Performing a GET request on a url (http://localhost:8080/helloworld) should return a <code>HTTP Status 200</code> and data with a json payload</p>
<div class="highlight"><pre class="chroma"><code class="language-json" data-lang="json"><span class="p">{</span><span class="nt">&#34;message&#34;</span><span class="p">:</span><span class="s2">&#34;helloworld&#34;</span><span class="p">}</span>
</code></pre></div><p>So lets get started!</p>
<p><strong>Create a Grails application</strong></p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">$ grails create-app RestHelloWorld
</code></pre></div><p><strong>Update your <code>build.gradle</code> to include the Rest Client Builder dependencies which we will need later on</strong></p>
<div class="highlight"><pre class="chroma"><code class="language-groovy" data-lang="groovy"><span class="n">dependencies</span> <span class="o">{</span>
    <span class="c1">// add the following line to the &#39;dependencies&#39; section
</span><span class="c1"></span>    <span class="n">testCompile</span> <span class="s2">&#34;org.grails:grails-datastore-rest-client:4.0.7.RELEASE&#34;</span>
<span class="o">}</span>
</code></pre></div><p><strong>Create an Integration Test</strong></p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">$ grails create-integration-test HelloWorld
</code></pre></div><p><strong>Create a test method inside the integration test</strong></p>
<p>Open up the created HelloWorldControllerSpec inside the <code>/src/integration-test/groovy/resthelloworld/</code> package</p>
<div class="highlight"><pre class="chroma"><code class="language-groovy" data-lang="groovy"><span class="kn">package</span> <span class="n">resthelloworld</span>

<span class="kn">import</span> <span class="nn">grails.test.mixin.integration.Integration</span>
<span class="kn">import</span> <span class="nn">grails.transaction.*</span>
<span class="kn">import</span> <span class="nn">spock.lang.*</span>
<span class="kn">import</span> <span class="nn">grails.plugins.rest.client.RestBuilder</span>
<span class="kn">import</span> <span class="nn">grails.plugins.rest.client.RestResponse</span>

<span class="nd">@Integration</span>
<span class="nd">@Rollback</span>
<span class="kd">class</span> <span class="nc">HelloWorldSpec</span> <span class="kd">extends</span> <span class="n">Specification</span> <span class="o">{</span>

    <span class="kt">def</span> <span class="nf">setup</span><span class="o">()</span> <span class="o">{</span>
    <span class="o">}</span>

    <span class="kt">def</span> <span class="nf">cleanup</span><span class="o">()</span> <span class="o">{</span>
    <span class="o">}</span>

    <span class="kt">def</span> <span class="s2">&#34;Ask for a nice HelloWorld&#34;</span><span class="o">()</span> <span class="o">{</span>
        <span class="nl">given:</span>
        <span class="n">RestBuilder</span> <span class="n">rest</span> <span class="o">=</span> <span class="k">new</span> <span class="n">RestBuilder</span><span class="o">()</span>

        <span class="nl">when:</span>
        <span class="n">RestResponse</span> <span class="n">response</span> <span class="o">=</span> <span class="n">rest</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s2">&#34;http://localhost:8080/helloworld/&#34;</span><span class="o">)</span>

        <span class="nl">then:</span>
        <span class="n">response</span><span class="o">.</span><span class="na">status</span> <span class="o">==</span> <span class="mi">200</span>

        <span class="nl">and:</span>
        <span class="n">response</span><span class="o">.</span><span class="na">json</span><span class="o">.</span><span class="na">message</span> <span class="o">==</span> <span class="s2">&#34;helloworld&#34;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div><p><strong>Run your test</strong></p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">$ grails test-app
</code></pre></div><p>Offcourse this will fail as we do not have implement the controller yet.</p>
<p><strong>Create a Rest controller</strong></p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">$ cd RestHelloWorld
$ grails create-controller HelloWorld
</code></pre></div><p><strong>Note:</strong> The generation of the controller also create a Unit Test for the controller, default this test will fail. We are going to delete the generated Unit Test as we do not need it now. This test is located under the <code>/src/test/</code> groovy package.</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">$ rm ./src/test/groovy/resthelloworld/HelloWorldControllerSpec.groovy
</code></pre></div><p><strong>Implement the controller function that will return data</strong></p>
<div class="highlight"><pre class="chroma"><code class="language-groovy" data-lang="groovy"><span class="kn">package</span> <span class="n">resthelloworld</span>

<span class="kd">class</span> <span class="nc">HelloWorldController</span> <span class="o">{</span>

    <span class="kt">def</span> <span class="nf">index</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">render</span><span class="o">(</span><span class="nl">status:</span> <span class="mi">200</span><span class="o">,</span> <span class="nl">contentType:</span> <span class="s2">&#34;application/json&#34;</span><span class="o">)</span> <span class="o">{</span>
            <span class="o">[</span><span class="s2">&#34;message&#34;</span> <span class="o">:</span> <span class="s2">&#34;helloworld&#34;</span><span class="o">]</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div><p><strong>Modify UrlMapping</strong></p>
<p>In order to get our newly generated controller accessible via Rest we need to modify our UrlMappings.</p>
<div class="highlight"><pre class="chroma"><code class="language-groovy" data-lang="groovy"><span class="kd">class</span> <span class="nc">UrlMappings</span> <span class="o">{</span>

    <span class="kd">static</span> <span class="n">mappings</span> <span class="o">=</span> <span class="o">{</span>
        <span class="s2">&#34;/$controller/$action?/$id?(.$format)?&#34;</span><span class="o">{</span>
            <span class="n">constraints</span> <span class="o">{</span>
                <span class="c1">// apply constraints here
</span><span class="c1"></span>            <span class="o">}</span>
        <span class="o">}</span>

        <span class="s2">&#34;/&#34;</span><span class="o">(</span><span class="nl">view:</span><span class="s2">&#34;/index&#34;</span><span class="o">)</span>
        <span class="s2">&#34;500&#34;</span><span class="o">(</span><span class="nl">view:</span><span class="s1">&#39;/error&#39;</span><span class="o">)</span>
        <span class="s2">&#34;404&#34;</span><span class="o">(</span><span class="nl">view:</span><span class="s1">&#39;/notFound&#39;</span><span class="o">)</span>

        <span class="c1">// add the line below
</span><span class="c1"></span>        <span class="s2">&#34;/helloworld/&#34;</span>  <span class="o">(</span><span class="nl">controller:</span> <span class="s2">&#34;helloWorld&#34;</span><span class="o">,</span> <span class="nl">action:</span> <span class="s2">&#34;index&#34;</span><span class="o">,</span> <span class="nl">method:</span> <span class="s2">&#34;GET&#34;</span><span class="o">)</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div><p><strong>Test your app</strong></p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">$ grails test-app
</code></pre></div><p>You should find that your tests are fine now :)</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">$ grails test-app
BUILD SUCCESSFUL

Total time: 2.054 secs
| Tests PASSED
</code></pre></div>
        </div>
    </div>
    <div class="row">
        <div class="twelve columns">
            <div class="post-meta-info">
                Published on
                
                    2015-11-19
                
                <span class="post-meta-info-taxonomy">
                    
                    
                    using tags:
                        <a href="/tags/grails">grails</a>, <a href="/tags/spock">spock</a>, <a href="/tags/rest">rest</a>, <a href="/tags/testing">testing</a>
                </span>
            </div>
        </div>
    </div>
</article>

        
        </div>
    </div>
</div>


<div class="container">
    <div class="row">
        <div class="twelve columns">
        
            <ul class="pager">
            
            
                <li>
                <a class="button" href="http://mpas.github.io/page/2">Older Posts &rarr;</a>
                </li>
            
            </ul>
        
        </div>
    </div>
</div>

<footer>
    <div class="container">
        <div class="row">
            <div class="twelve columns">
                <div id="social">
                    
                        <a title="Twitter" href="https://twitter.com/marcopas">
                            <i class="fab fa-twitter"></i>
                        </a>
                    
                    
                        <a title="LinkedIn" href="https://www.linkedin.com/in/marcopas">
                            <i class="fab fa-linkedin"></i>
                        </a>
                    
                    
                        <a title="GitHub" href="https://github.com/mpas">
                            <i class="fab fa-github"></i>
                        </a>
                    
                    
                        <a title="StackOverflow" href="http://stackoverflow.com/users/185432/marco">
                            <i class="fab fa-stack-overflow"></i>
                        </a>
                    
                    
                    
                    
                        <a title="Email" href="mailto:marco.pasopas@gmail.com">
                            <i class="far fa-envelope"></i>
                        </a>
                    
            </div>
        </div>

        <div class="row">
            <div class="twelve columns" id="copyright">&copy; 2020 ~ CodeVerse / Powered by <a href="http://gohugo.io/">Hugo</div>
        </div>
    </div>
</footer>
</body>
</html>

